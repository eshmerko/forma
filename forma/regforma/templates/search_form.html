{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container">
    <h1>Поиск закупок</h1>
    <form method="post" id="search-form">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Поиск</button>
    </form>

    <!-- Прогресс-бар -->
    <div id="progress-container" class="progress-container">
        <div id="progress-bar" class="progress-bar"></div>
        <div id="progress-text" class="progress-text">0%</div>
    </div>

    {% if percentages %}
        <h2>Результаты для "{{ search_term }}"</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Код OKPB</th>
                    <th>Вид экономической деятельности</th>
                    <th>Процент вхождений</th>
                </tr>
            </thead>
            <tbody>
                {% for code, percentage in percentages.items %}
                    <tr>
                        <td>{{ code }}</td>
                        <td>{{ economic_activities|get_item:code }}</td>
                        <td>{{ percentage|floatformat:2 }}%</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>

<!-- JavaScript для прогресс-бара -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('search-form');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        form.addEventListener('submit', async function (event) {
            event.preventDefault(); // Предотвращаем стандартную отправку формы

            const totalPages = 2; // Общее количество страниц
            let currentPage = 0;

            // Функция для обновления прогресс-бара
            function updateProgress(progress) {
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${Math.round(progress)}%`;
            }

            // Начальное состояние прогресс-бара
            updateProgress(0);

            // Выполняем запросы к API
            for (let page = 0; page < totalPages; page++) {
                try {
                    // Отправляем POST-запрос
                    const response = await fetch("https://www.gias.by/search/api/v1/search/purchases", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36'
                        },
                        body: JSON.stringify({
                            contextTextSearch: "{{ form.contextTextSearch.value }}", // Используем значение из формы
                            page: page,
                            pageSize: 10,
                            sortField: "dtCreate",
                            sortOrder: "DESC"
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Ошибка HTTP: ${response.status}`);
                    }

                    const data = await response.json();

                    // Обновляем прогресс-бар
                    currentPage++;
                    const progress = (currentPage / totalPages) * 100;
                    updateProgress(progress);

                    // Пауза между запросами (если нужно)
                    await new Promise(resolve => setTimeout(resolve, 2000));
                } catch (error) {
                    console.error('Ошибка при запросе к API:', error);
                }
            }

            // После завершения всех запросов отправляем форму
            form.submit();
        });
    });
</script>
{% endblock %}