{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container">
    <h1>Подбор кода ОКРБ по наименованию</h1>
    <form method="post" id="search-form">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Поиск</button>
    </form>

    <!-- Прогресс-бар -->
    <div id="progress-container" class="progress-container" style="display: none;">
        <div id="progress-bar" class="progress-bar"></div>
        <div id="progress-text" class="progress-text">0%</div>
    </div>

    <!-- Результаты поиска -->
    <div id="results-container" style="display: none;">
        <h2>Результаты для "<span id="search-term"></span>"</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Код OKPБ</th>
                    <th>Вид экономической деятельности</th>
                    <th>Вероятностный процент подбора</th>
                </tr>
            </thead>
            <tbody id="results-body">
                <!-- Сюда будут добавлены строки с результатами -->
            </tbody>
        </table>
    </div>
</div>

<!-- JavaScript для прогресс-бара и динамического обновления результатов -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('search-form');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const resultsContainer = document.getElementById('results-container');
        const resultsBody = document.getElementById('results-body');
        const searchTerm = document.getElementById('search-term');

        form.addEventListener('submit', function (event) {
            event.preventDefault(); // Предотвращаем стандартную отправку формы

            // Показываем прогресс-бар
            progressContainer.style.display = 'block';

            // Скрываем предыдущие результаты
            resultsContainer.style.display = 'none';
            resultsBody.innerHTML = '';

            // Отправляем форму через AJAX
            const formData = new FormData(form);
            fetch("{% url 'search' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'  // Указываем, что запрос выполняется через AJAX
                }
            }).then(response => response.json())
              .then(data => {
                // Обновляем прогресс-бар до 100%
                progressBar.style.width = '100%';
                progressText.textContent = '100%';

                // Отображаем результаты
                searchTerm.textContent = data.search_term;
                resultsBody.innerHTML = Object.entries(data.percentages)
                    .map(([code, percentage]) => `
                        <tr>
                            <td>${code}</td>
                            <td>${data.economic_activities[code]}</td>
                            <td>${percentage.toFixed(2)}%</td>
                        </tr>
                    `)
                    .join('');
                resultsContainer.style.display = 'block';
            });

            // Запускаем опрос сервера для получения прогресса
            const interval = setInterval(async () => {
                const response = await fetch("{% url 'get_progress' %}");
                const data = await response.json();
                const progress = data.progress;

                // Обновляем прогресс-бар
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${Math.round(progress)}%`;

                // Останавливаем опрос, если прогресс достиг 100%
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 1000); // Опрашиваем сервер каждую секунду
        });
    });
</script>
{% endblock %}