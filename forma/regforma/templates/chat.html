<!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ -->
<button id="chat-button">üí¨</button>

<!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
<div id="chat-container">
    <div id="chat-header">–ß–∞—Ç-–±–æ—Ç</div>
    <div id="messages">
        <div class="bot-message message">–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à —á–∞—Ç-–±–æ—Ç –Ω–∞ –±–∞–∑–µ –ò–ò.</div>
    </div>
    <form id="chat-form">
        <input type="text" id="message" name="message" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const chatButton = document.getElementById('chat-button');
        const chatContainer = document.getElementById('chat-container');
        const form = document.getElementById('chat-form');
        const messageInput = document.getElementById('message');
        const messagesDiv = document.getElementById('messages');

        // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
        chatButton.addEventListener('click', () => {
            chatContainer.style.display = chatContainer.style.display === 'none' || !chatContainer.style.display ? 'flex' : 'none';
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            appendMessage(userMessage, 'user-message');
            messageInput.value = '';

            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const typingIndicator = document.createElement('div');
            typingIndicator.classList.add('typing-indicator');
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            messagesDiv.appendChild(typingIndicator);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await fetch('/chat/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ message: userMessage }),
                });

                messagesDiv.removeChild(typingIndicator); // –£–¥–∞–ª–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞

                if (!response.ok) {
                    appendMessage('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'bot-message');
                    return;
                }

                const data = await response.json();
                const botMessage = data.response || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–æ—Ç–∞.';
                typeMessage(botMessage, 'bot-message');
            } catch (error) {
                messagesDiv.removeChild(typingIndicator); // –£–¥–∞–ª–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏ –æ—à–∏–±–∫–µ
                appendMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É.', 'bot-message');
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –Ω–∞–±–æ—Ä–∞
        function typeMessage(content, className) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', className);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑

            let i = 0;
            function typingEffect() {
                if (i < content.length) {
                    messageDiv.innerHTML += content.charAt(i); // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è HTML-—Ä–∞–∑–º–µ—Ç–∫–∏
                    i++;
                    setTimeout(typingEffect, 50); // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–∏–º–≤–æ–ª–∞–º–∏ (50 –º—Å)
                }
            }

            typingEffect(); // –ó–∞–ø—É—Å–∫–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
        function appendMessage(content, className) {
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = content; // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è HTML
            messageDiv.classList.add('message', className);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        }
    });
</script>