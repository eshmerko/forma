{% extends 'base.html' %}
{% load static %}

{% block content %}
    <div class="container d-flex justify-content-center align-items-center" style="height: 70vh;">
        <div class="row">
            <div class="col-md-12">
                <h2 class="text-center">Введите коды ОКРБ</h2>
                <form method="post" class="mt-4" id="parser-form">
                    {% csrf_token %}
                    <!-- Контейнер для полей ввода -->
                    <div id="input-container">
                        <div class="form-group mb-3">
                            <input type="text" class="form-control custom-input" name="index[]" placeholder="01.49.19.100" oninput="validateInput(this)" required>
                            <small class="form-text text-muted">Разрешены только цифры и точки.</small>
                        </div>
                    </div>

                    <!-- Кнопка для добавления нового поля -->
                    <button type="button" class="btn btn-secondary mb-3" onclick="addInputField()">Добавить еще код</button>

                    <!-- Кнопка отправки формы -->
                    <button type="submit" class="btn btn-primary mt-3 d-block mx-auto">Начать парсинг</button>
                </form>

                <!-- Спиннер -->
                <div id="spinner" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Идет обработка запроса...</p>
                </div>

                <!-- Прогресс-бар -->
                <div id="progressContainer" class="mt-4" style="display: none;">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <p id="progressText" class="text-center mt-2">Идет парсинг, пожалуйста подождите...</p>
                </div>

                <!-- Контейнер для результата -->
                <div id="resultContainer" class="mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS и зависимости -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <!-- Ваши скрипты -->
    <script>
        // Функция для добавления нового поля ввода
        function addInputField() {
            const container = document.getElementById('input-container');
            const newInput = document.createElement('div');
            newInput.classList.add('form-group', 'mb-3');
            newInput.innerHTML = `
                <input type="text" class="form-control custom-input" name="index[]" placeholder="01.49.19.100" oninput="validateInput(this)" required>
                <small class="form-text text-muted">Разрешены только цифры и точки.</small>
            `;
            container.appendChild(newInput);
        }

        // Отправка формы
        document.getElementById('parser-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Предотвращаем стандартную отправку формы

            var form = event.target;
            var formData = new FormData(form);
            var spinner = document.getElementById('spinner');
            var progressContainer = document.getElementById('progressContainer');
            var progressBar = document.getElementById('progressBar');
            var progressText = document.getElementById('progressText');
            var resultContainer = document.getElementById('resultContainer');

            // Показываем спиннер и прогресс-бар
            spinner.style.display = 'block';
            progressContainer.style.display = 'block';

            // Отправляем данные формы через AJAX
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest', // Для Django, чтобы определить AJAX запрос
                },
            })
            .then(response => response.json())
            .then(data => {
                // Скрываем спиннер
                spinner.style.display = 'none';

                // Обновляем прогресс-бар
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressText.textContent = 'Парсинг завершен!';

                // Отображаем результат
                resultContainer.innerHTML = `
                    <h3>Результаты парсинга:</h3>
                    <p>Скачать CSV: <a href="${data.csv_file}" download>Скачать CSV</a></p>
                    <p>Скачать ссылки: <a href="${data.links_file}" download>Скачать links.txt</a></p>
                `;
            })
            .catch(error => {
                console.error('Ошибка:', error);
                spinner.style.display = 'none';
                progressContainer.style.display = 'none';
                resultContainer.innerHTML = '<p class="text-danger">Произошла ошибка при обработке запроса.</p>';
            });
        });
    </script>
{% endblock %}